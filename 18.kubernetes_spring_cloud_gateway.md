# Secci칩n 18: Kubernetes: Spring Cloud Gateway

---

## Introducci칩n

En esta secci칩n aprenderemos a crear y configurar un `API Gateway` utilizando `Spring Cloud Gateway` dentro de un
entorno `Kubernetes`.

El `API Gateway` cumple un rol fundamental en una arquitectura de microservicios, ya que act칰a como un punto de entrada
칰nico para todos los clientes. Entre sus funciones principales se encuentran:

- `Enrutamiento din치mico`: redirige las solicitudes entrantes a los microservicios correspondientes.
- `Balanceo de carga`: distribuye las peticiones entre m칰ltiples r칠plicas de un mismo servicio.
- `Cross-cutting concerns (Preocupaciones transversales)`: como autenticaci칩n, autorizaci칩n, logging, m칠tricas, etc.
- `Desacoplamiento`: los clientes no necesitan conocer la ubicaci칩n real de cada microservicio, sino que solo
  interact칰an con el `gateway`.

En este caso, nuestro `Spring Cloud Gateway` se integrar치 con `Kubernetes Service Discovery`, aprovechando el cliente
de `Kubernetes` para descubrir din치micamente los servicios disponibles.

## Creando el servicio Spring Cloud Gateway

Generamos un nuevo proyecto desde `Spring Initializr`, seleccionando:

````xml
<!--Spring Boot 3.5.4-->
<!--Spring Cloud Version 2025.0.0-->
<!--Java 21-->

<dependencies>
    <dependency>
        <groupId>org.springframework.boot</groupId>
        <artifactId>spring-boot-starter-actuator</artifactId>
    </dependency>
    <dependency>
        <groupId>org.springframework.cloud</groupId>
        <artifactId>spring-cloud-starter-gateway-server-webflux</artifactId>
    </dependency>

    <!--Agregados manualmente-->
    <dependency>
        <groupId>org.springframework.cloud</groupId>
        <artifactId>spring-cloud-starter-kubernetes-client</artifactId>
    </dependency>
    <dependency>
        <groupId>org.springframework.cloud</groupId>
        <artifactId>spring-cloud-starter-kubernetes-client-loadbalancer</artifactId>
    </dependency>
    <!--/Agregados manualmente-->

    <dependency>
        <groupId>org.projectlombok</groupId>
        <artifactId>lombok</artifactId>
        <optional>true</optional>
    </dependency>
    <dependency>
        <groupId>org.springframework.boot</groupId>
        <artifactId>spring-boot-starter-test</artifactId>
        <scope>test</scope>
    </dependency>
    <dependency>
        <groupId>io.projectreactor</groupId>
        <artifactId>reactor-test</artifactId>
        <scope>test</scope>
    </dependency>
</dependencies>
````

## Configurando el servicio Spring Cloud Gateway

Para habilitar el descubrimiento de servicios en `Kubernetes`, a침adimos la anotaci칩n `@EnableDiscoveryClient` en la
clase principal de la aplicaci칩n.

````java

@EnableDiscoveryClient
@SpringBootApplication
public class GatewayServerApplication {

    public static void main(String[] args) {
        SpringApplication.run(GatewayServerApplication.class, args);
    }
}
````

De esta forma, nuestro `gateway-server` podr치 registrarse como cliente de Kubernetes y descubrir autom치ticamente otros
servicios desplegados en el cl칰ster.

En el archivo `application.yml`, configuramos:

- El puerto donde correr치 el contenedor (`8090` por defecto, configurable con `CONTAINER_PORT`).
- El nombre de la aplicaci칩n, necesario para la integraci칩n con `Kubernetes Service Discovery`.
- Configuraci칩n de errores para incluir el mensaje en las respuestas (`include-message: always`).

````yml
server:
  port: ${CONTAINER_PORT:8090}
  error:
    include-message: always

spring:
  application:
    name: gateway-server
````

游녤 Con esto dejamos listo el esqueleto del `Gateway`, que luego iremos ampliando con rutas, balanceo de carga y pruebas.
