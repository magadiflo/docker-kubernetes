# Sección 16: Kubernetes: ConfigMap y Secret - Configuración centralizada

---

## [ConfigMaps](https://kubernetes.io/docs/concepts/configuration/configmap/)

Un `ConfigMap` es un *objeto de la API de Kubernetes que se utiliza para almacenar datos de configuración no
confidenciales en forma de pares `clave-valor`*. Los pods pueden consumir un `ConfigMap` de distintas formas:

- Como variables de entorno.
- Argumentos en la línea de comandos.
- Archivos montados dentro del contenedor mediante un volumen.

Los `ConfigMap` permiten desacoplar la configuración específica del entorno del código fuente o de la imagen del
contenedor, facilitando así la portabilidad y reutilización de las aplicaciones entre distintos entornos (desarrollo,
pruebas, producción, etc.).

⚠️ Precaución
> Un `ConfigMap` `no proporciona confidencialidad ni cifrado`. Si necesitas almacenar información sensible (como
> contraseñas, tokens o claves de acceso), debes usar un objeto `Secret`, o bien emplear herramientas adicionales para
> mantener los datos protegidos.

Se recomienda utilizar `ConfigMaps` para mantener la configuración separada del código de la aplicación. Esto promueve
buenas prácticas como el principio de configuración externa, uno de los pilares de las aplicaciones modernas y
escalables.

### Ejemplo práctico

Imagina que estás desarrollando una aplicación que se ejecuta localmente durante el desarrollo y en la nube para el
entorno productivo. En lugar de codificar directamente las direcciones de los servicios, configuras tu aplicación para
que lea una variable de entorno llamada `DATABASE_HOST`.

- En desarrollo local, esa variable podría tener el valor `localhost`.
- En producción, la variable podría apuntar al nombre de un servicio de Kubernetes que expone la base de datos dentro
  del clúster.

Gracias al `ConfigMap`, puedes reutilizar exactamente la misma imagen de contenedor en ambos entornos, modificando
únicamente los valores de configuración.

ℹ️ Nota
> Un `ConfigMap` no está diseñado para almacenar grandes volúmenes de datos. El tamaño total de los datos almacenados no
> debe exceder `1 MiB`. Si necesitas administrar configuraciones más grandes, considera otras alternativas como montar
> un volumen, usar un almacenamiento externo o una base de datos.

## [Secrets](https://kubernetes.io/docs/concepts/configuration/secret/)

Un `Secret` es un *objeto de la API de Kubernetes que se utiliza para almacenar y gestionar información sensible*, como
contraseñas, tokens, claves SSH, certificados u otros datos privados.

Este tipo de objeto permite *evitar incluir datos confidenciales directamente en los manifiestos de los Pods o en las
imágenes de contenedor*, mejorando así la seguridad general de la aplicación y del clúster.

Diferencia clave respecto a `ConfigMaps`
> Aunque los `Secrets` son similares a los `ConfigMaps` en estructura y uso, están específicamente diseñados para
> manejar datos sensibles, con medidas de seguridad adicionales.

### Ventajas del uso de Secrets

- `Separación de responsabilidades`: los secretos pueden definirse y gestionarse de forma independiente al resto de los
  recursos del clúster.
- `Reducción del riesgo de exposición`: como los `Secrets` no necesitan estar embebidos en los `Pods`, se evita que los
  datos sensibles se expongan durante el ciclo de vida del despliegue.
- Tratamiento más seguro: `Kubernetes` puede tomar precauciones adicionales, como evitar que los secretos se escriban en
  disco (dependiendo de la configuración del nodo), o restringir su visibilidad a través de `RBAC`.

### Formas de consumo

Los `Secrets` pueden ser consumidos por los `Pods` de las siguientes maneras:

- Como variables de entorno.
- Montados como archivos dentro de un volumen.
- Referenciados directamente desde las definiciones de contenedores, por ejemplo, para configurar credenciales.

### Consideraciones adicionales

- Por defecto, los datos dentro de un `Secret` están codificados en `Base64`, lo que no implica cifrado real. Se
  recomienda habilitar el cifrado en reposo en el clúster de `Kubernetes` y usar controles de acceso adecuados.
- También se puede integrar `Kubernetes` con soluciones externas de gestión de secretos, como `HashiCorp Vault`,
  `AWS Secrets Manager`, `Azure Key Vault`, entre otros, para obtener mayor control y seguridad.

## Agregando ConfigMaps para los microservicios

A continuación, definimos los archivos `ConfigMap` para los microservicios de usuarios y cursos,
`con el fin de centralizar la configuración no confidencial` de cada uno.

`configmap-user.yml`

````yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: cm-user-service
data:
  container_port: '8001'
  db_host: s-mysql
  db_port: '3306'
  db_name: db_user_service
  db_username: admin
  db_password: magadiflo
  course_service_host: s-course-service
  course_service_port: '8002'
````

`configmap-course.yml`

````yml
apiVersion: v1
kind: ConfigMap
metadata:
  name: cm-course-service
data:
  container_port: '8002'
  db_host: s-postgres
  db_port: '5432'
  db_name: db_course_service
  db_username: postgres
  db_password: magadiflo
  user_service_host: s-user-service
  user_service_port: '8001'
````

Explicación

- Como vimos previamente, un `ConfigMap` permite `almacenar datos de configuración no confidenciales` en forma de pares
  `clave-valor`.
- En este caso, estamos almacenando:
    - Configuración de la base de datos (`host`, `puerto`, `nombre`, `usuario` y `contraseña`).
    - Información para la comunicación entre microservicios (`host` y` puerto del servicio relacionado`).
- Las claves definidas en el `ConfigMap` pueden ir en minúsculas porque simplemente representan nombres de
  configuración dentro del par `clave-valor` (por ejemplo, `db_host: s-postgres`).
- Las variables de entorno reales se definirán luego en el `Deployment`, donde puedes mapear una variable en
  mayúsculas (como `DB_HOST`) a la clave del `ConfigMap` (`db_host`). Es allí donde se establece la relación entre
  ambas.

> ⚠️ `Importante`: Aunque en este ejemplo se están incluyendo `db_username` y `db_password` dentro del `ConfigMap`,
> en la práctica estos datos deberían manejarse con un objeto `Secret`, ya que contienen información sensible.
> Este cambio se implementará más adelante en la lección correspondiente.

### Aplicando los ConfigMaps al clúster

Una vez creados los archivos `YAML`, aplicamos ambos `ConfigMap` con el siguiente comando:

````bash
$ kubectl apply -f .\kubernetes\configmaps\configmap-course.yml -f .\kubernetes\configmaps\configmap-user.yml
configmap/cm-course-service created
configmap/cm-user-service created
````

Luego, listándolos, verificamos que los `configMaps` hayan sido creados.

````bash
$ kubectl get configMap
NAME                DATA   AGE
cm-course-service   8      22s
cm-user-service     8      22s
kube-root-ca.crt    1      14d
````

En la columna `DATA` se muestra la cantidad de `claves (key)` definidas en el bloque `data:` del `ConfigMap`.
Por ejemplo, `cm-user-service` contiene `8` pares `clave-valor`, por lo tanto, su valor en la columna `DATA` es `8`.
